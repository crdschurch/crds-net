<!-- Crossroads Analytics Wrapper -->
<script>
  (function initAnalytics() {
    // Guard: only run in browser
    if (typeof window === 'undefined') return;

    // Configuration
    {% if site.jekyll_env == 'production' %}
    var SEGMENT_WRITE_KEY = 'nPCU8RuoHt5Ip7tj3UdS4ek0A53a8dGW';
    {% else %}
    var SEGMENT_WRITE_KEY = '6urDjS9ewsjC9YAbSuihDc0TY7Xrv39b';
    {% endif %}

    var WRAPPER_SRC = '{{ site.ENV.ANALYTICS_WRAPPER_URL }}';

    // Add browser polyfills for Node.js globals BEFORE loading script
    if (typeof window.process === 'undefined') {
      window.process = { env: {} };
    }
    if (typeof window.global === 'undefined') {
      window.global = window;
    }

    var doInitialize = function() {
      try {
        // If already initialized, just send page tracking
        if (window.CrossroadsAnalytics && window.CrossroadsAnalytics.isInitialized && window.CrossroadsAnalytics.isInitialized()) {
          sendPageView();
          return;
        }


        // Configuration object
        var config = {
          writeKey: SEGMENT_WRITE_KEY,
          autoTrack: true
        };

        // Try to initialize - check both method names
        var initMethod = window.CrossroadsAnalytics && (window.CrossroadsAnalytics.initialize || window.CrossroadsAnalytics.initializeAnalytics);
        if (!initMethod) {
          return;
        }

        var maybePromise = initMethod.call(window.CrossroadsAnalytics, config);

        // Handle promise or immediate return
        if (maybePromise && typeof maybePromise.then === 'function') {
          maybePromise
            .then(function() {
              setupCommonProperties();
              if (window.CrossroadsAnalytics.ready) {
                window.CrossroadsAnalytics.ready(sendPageView);
              } else {
                setTimeout(sendPageView, 100);
              }
            })
            .catch(function(e) {
              setTimeout(sendPageView, 100);
            });
        } else {
          setupCommonProperties();
          if (window.CrossroadsAnalytics.ready) {
            window.CrossroadsAnalytics.ready(sendPageView);
          } else {
            setTimeout(sendPageView, 100);
          }
        }
      } catch (e) {
        // Silent error handling
      }
    };

    var setupCommonProperties = function() {
      try {
        if (window.CrossroadsAnalytics && window.CrossroadsAnalytics.setCommonProperties) {
          window.CrossroadsAnalytics.setCommonProperties({
            environment: '{{ site.jekyll_env }}',
            site: 'crds-net'
          });
        }
      } catch (e) {
        // Silent error handling
      }
    };

    var sendPageView = function() {
      try {
        if (!window.CrossroadsAnalytics || !window.CrossroadsAnalytics.page) {
          return;
        }

        var canonical = (function() {
          var l = document.querySelector('link[rel="canonical"]');
          return l ? l.href : '';
        })();

        var pageProps = {
          url: window.location.href,
          path: window.location.pathname,
          canonicalUrl: canonical,
          referrer: document.referrer || '',
          title: document.title,
          contentType: {{ page.content_type | jsonify }},
          contentfulEntryId: {{ page.contentful_id | jsonify }},
          siteSection: {{ page.snail_trail | jsonify }},
          distributionChannels: {{ page.distribution_channels | jsonify }},
          environment: '{{ site.jekyll_env }}'
        };

        window.CrossroadsAnalytics.page(undefined, document.title, pageProps);
      } catch (e) {
        // Silent error handling
      }
    };

    var loadAnalyticsScript = function() {
      var script = document.createElement('script');
      script.src = WRAPPER_SRC;
      script.async = true;

      script.addEventListener('load', function() {
        doInitialize();
      }, { once: true });

      script.addEventListener('error', function() {
        // Silent error handling
      }, { once: true });

      document.head.appendChild(script);
    };

    // Setup compatibility aliases
    window.analytics = window.analytics || {};
    window.analytics.track = function(e, p) {
      if (window.CrossroadsAnalytics && typeof window.CrossroadsAnalytics.track === 'function') {
        window.CrossroadsAnalytics.track(e, p || {});
      }
    };
    window.analytics.page = function(c, n, p) {
      if (window.CrossroadsAnalytics && typeof window.CrossroadsAnalytics.page === 'function') {
        window.CrossroadsAnalytics.page(c, n, p || {});
      }
    };
    window.analytics.identify = function(id, t) {
      if (window.CrossroadsAnalytics && typeof window.CrossroadsAnalytics.identify === 'function') {
        window.CrossroadsAnalytics.identify(id, t || {});
      }
    };

    // If already present and loaded, initialize immediately
    if (window.CrossroadsAnalytics) {
      doInitialize();
      return;
    }

    // Check if script is already loading
    var existingScript = document.querySelector('script[src="' + WRAPPER_SRC + '"]');
    if (existingScript) {
      existingScript.addEventListener('load', doInitialize, { once: true });
      return;
    }

    // Load the analytics script
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadAnalyticsScript, { once: true });
    } else {
      loadAnalyticsScript();
    }
  })();
</script>
<!-- END: Crossroads Analytics Wrapper -->
